<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet"
    />

    <style>
      .dropdown-content {
        display: none;
        position: absolute;
        right: 0;
        min-width: 160px;
        z-index: 50;
      }

      .dropdown:hover .dropdown-content {
        display: block;
      }

      .modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        padding: 20px;
        width: 600px;
        max-width: 90%;
      }

      .modal-content {
        display: flex;
        flex-direction: column;
      }

      .modal-body {
        display: flex;
        justify-content: space-between;
        gap: 20px;
      }

      .modal-section {
        flex: 1;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 8px;
        background-color: #f9f9f9;
      }

      .modal h2 {
        margin-bottom: 20px;
        text-align: center;
      }

      .modal h3 {
        margin-bottom: 10px;
      }

      .modal h3,
      h4 {
        color: #1565c0;
        background-color: #e3f2fd;
        border-radius: 4px;
        font-size: 16px;
      }

      .modal-close {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #d9534f;
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        font-size: 16px;
        cursor: pointer;
      }

      .modal-close:hover {
        background: #c9302c;
      }

      .modal-section h4 {
        margin-top: 20px;
        padding: 5px 10px;
      }

      .modalBtn,
      .editBtn {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .fidelity {
        display: flex;
        gap: 5px;
        margin-top: 10px;
      }

      .heart {
        font-size: 24px;
        color: #e0e0e0;
        cursor: default;
      }

      .heart.filled {
        color: #ff5252;
      }

      .editBtn {
        color: #ff6200;
        transition: color 0.2s ease-in-out;
      }

      .editBtn:hover {
        color: #793101;
      }
    </style>
  </head>
  <body class="bg-gray-100">
    <nav class="bg-white shadow-md">
      <div class="max-w-7xl mx-auto px-4">
        <div class="flex justify-between h-16">
          <div class="flex items-center">
            <span class="text-xl font-bold text-blue-600">Dashboard</span>
          </div>

          <div class="flex items-center">
            <div class="dropdown relative">
              <button
                class="flex items-center space-x-2 text-gray-700 hover:text-gray-900 px-4 py-2 rounded-md"
              >
                <span id="userEmail"></span>
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-5 w-5"
                  viewBox="0 0 20 20"
                  fill="currentColor"
                >
                  <path
                    fill-rule="evenodd"
                    d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"
                    clip-rule="evenodd"
                  />
                </svg>
              </button>

              <div class="dropdown-content bg-white rounded-md shadow-xl mt-2">
                <a
                  href="/profile"
                  class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                >
                  Editar Perfil
                </a>
                <button
                  id="logoutBtn"
                  class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                >
                  Sair
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </nav>
    <div class="container mx-auto px-4 py-8">
      <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
          <!-- Contêiner para os campos de pesquisa -->
          <div class="flex flex-wrap gap-2">
            <input
              type="text"
              id="searchInput"
              class="min-w-[150px] px-2 py-1 text-sm border rounded-md"
              placeholder="Pesquisar por nome..."
            />
            <select
              id="statusFilter"
              class="min-w-[150px] px-2 py-1 text-sm border rounded-md"
            >
              <option value="">Todos os Status</option>
              <option value="em negociação">Em negociação</option>
              <option value="contrato fechado">Contrato fechado</option>
              <option value="inadimplente">Inadimplente</option>
            </select>
            <input
              type="text"
              id="emailFilter"
              class="min-w-[150px] px-2 py-1 text-sm border rounded-md"
              placeholder="Pesquisar por e-mail..."
            />
            <input
              type="text"
              id="phoneFilter"
              class="min-w-[150px] px-2 py-1 text-sm border rounded-md"
              placeholder="Pesquisar por telefone..."
            />
          </div>

          <!-- Botão Add Clientes -->
          <a
            href="/register-client"
            class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-3 text-sm rounded"
          >
            Add Clientes
          </a>
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full table-auto">
            <thead>
              <tr class="bg-gray-200">
                <th class="px-4 py-2 text-left">Nome</th>
                <th class="px-4 py-2 text-left">Status</th>
                <th class="px-4 py-2 text-left">Email</th>
                <th class="px-4 py-2 text-left">Telefone</th>
                <th class="px-4 py-2 text-left">View</th>
                <th class="px-4 py-2 text-left">Edit</th>
              </tr>
            </thead>
            <tbody id="clientsList">
              <!-- Produtos serão inseridos aqui via JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div id="modal" class="modal hidden">
      <div class="modal-content">
        <h2 id="modalTitle"></h2>
        <div class="modal-body">
          <!-- Primeiro container: Dados Pessoais -->
          <div class="modal-section" id="personalData">
            <h3>Dados Pessoais</h3>
            <p><strong>Nome:</strong> <span id="clientName"></span></p>
            <p><strong>Idade:</strong> <span id="clientAge"></span> anos</p>
            <p><strong>CPF:</strong> <span id="clientCPF"></span></p>
            <h4>Contatos</h4>
            <p><strong>Email:</strong> <span id="clientEmail"></span></p>
            <p><strong>Telefone:</strong> <span id="clientPhone"></span></p>
          </div>
          <!-- Segundo container: Informações -->
          <div class="modal-section" id="additionalInfo">
            <h3>Informações</h3>
            <p><strong>Fidelidade:</strong></p>
            <div class="fidelity">
              <span class="heart" data-level="1">♥</span>
              <span class="heart" data-level="2">♥</span>
              <span class="heart" data-level="3">♥</span>
              <span class="heart" data-level="4">♥</span>
              <span class="heart" data-level="5">♥</span>
            </div>
            <p><strong>Status:</strong> <span id="clientStatus"></span></p>
            <p><strong>Observações: </strong><span id="clientObs"></span></p>
          </div>
        </div>
        <button class="modal-close" onclick="closeModal()">X</button>
      </div>
    </div>

    <script>
      let clients = [];
      async function loadClients() {
        try {
          const responseUser = await fetch("/users/profile");
          if (!responseUser.ok) {
            window.location.href = "/login";
            return;
          }
          const user = await responseUser.json();
          document.getElementById("userEmail").textContent = user.email;

          const response = await fetch("/clients");
          clients = await response.json();

          renderClientList(clients);
        } catch (error) {
          console.error("Error:", error);
          window.location.href = "/login";
        }
      }
      // Função para renderizar a lista de clientes
      function renderClientList(filteredClients) {
        const clientsList = document.getElementById("clientsList");
        clientsList.innerHTML = filteredClients
          .map(
            (client, index) => `
          <tr class="border-b">
            <td class="px-4 py-2">${client.name}</td>
            <td class="px-4 py-2">${client.status}</td>
            <td class="px-4 py-2">${client.email}</td>
            <td class="px-4 py-2">${client.telephone.replace(
              /(\d{2})(\d{5})(\d{4})/,
              "($1) $2-$3"
            )}</td>
            <td class="px-4 py-2">
              <button class="modalBtn" data-index="${index}" title="Visualizar">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500 hover:text-blue-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                </svg>
              </button>
            <td class="px-4 py-2">
              <a href="/edit-client/${
                client.id
              }" class="editBtn" title="Editar">
                <i class="fas fa-pencil-alt text-orange-500 hover:text-orange-700 h-6 w-6"></i>
              </a>
            </td>
          `
          )
          .join("");
        // Adicionar eventos de clique aos botões do modal
        document
          .getElementById("clientsList")
          .addEventListener("click", (event) => {
            const button = event.target.closest(".modalBtn"); // Verifica se o botão foi clicado
            if (button) {
              const index = button.getAttribute("data-index");
              openModal(clients[index]); // Passa o cliente correspondente
            }
          });
      }

      // Função para filtrar clientes com base no nome
      function filterClientsByName(query) {
        if (!query) {
          return clients; // Retorna todos os clientes se não houver consulta
        }
        return clients.filter((client) =>
          client.name.toLowerCase().includes(query.toLowerCase())
        );
      }

      document
        .getElementById("searchInput")
        .addEventListener("input", applyFilters);
      document
        .getElementById("statusFilter")
        .addEventListener("change", applyFilters);
      document
        .getElementById("emailFilter")
        .addEventListener("input", applyFilters);
      document
        .getElementById("phoneFilter")
        .addEventListener("input", applyFilters);

      function applyFilters() {
        const nameQuery = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const statusQuery = document.getElementById("statusFilter").value;
        const emailQuery = document
          .getElementById("emailFilter")
          .value.toLowerCase();
        const phoneQuery = document.getElementById("phoneFilter").value;

        const filteredClients = clients.filter((client) => {
          const matchesName = client.name.toLowerCase().includes(nameQuery);
          const matchesStatus = !statusQuery || client.status === statusQuery;
          const matchesEmail = client.email.toLowerCase().includes(emailQuery);
          const matchesPhone = client.telephone.includes(phoneQuery);

          return matchesName && matchesStatus && matchesEmail && matchesPhone;
        });

        renderClientList(filteredClients);
      }

      // Evento para a barra de pesquisa
      document
        .getElementById("searchInput")
        .addEventListener("input", (event) => {
          const query = event.target.value;
          const filteredClients = filterClientsByName(query);
          renderClientList(filteredClients);
        });

      // Função para abrir o modal
      function openModal(client) {
        const age = calculateAge(client.birth_date);
        const modal = document.getElementById("modal");
        modal.classList.remove("hidden");
        document.getElementById("modalTitle").textContent =
          "Detalhes do Cliente";
        document.getElementById("clientName").textContent = client.name;
        document.getElementById("clientAge").textContent = age;
        document.getElementById("clientCPF").textContent = client.cpf || "N/A";
        document.getElementById("clientEmail").textContent = client.email;
        document.getElementById("clientPhone").textContent = client.telephone;
        document.getElementById("clientStatus").textContent = client.status;
        document.getElementById("clientObs").textContent = client.obs || "";

        // Atualiza os corações com base na fidelidade
        const hearts = document.querySelectorAll(".heart");
        hearts.forEach((heart) => {
          const level = parseInt(heart.getAttribute("data-level"), 10);
          if (level <= client.fidelity) {
            heart.classList.add("filled");
          } else {
            heart.classList.remove("filled");
          }
        });
      }

      // Função para calcular a idade
      function calculateAge(birthDate) {
        const birth = new Date(birthDate);
        const today = new Date();
        let age = today.getFullYear() - birth.getFullYear();
        const isBirthdayPassed =
          today.getMonth() > birth.getMonth() ||
          (today.getMonth() === birth.getMonth() &&
            today.getDate() >= birth.getDate());
        if (!isBirthdayPassed) {
          age--;
        }
        return age;
      }

      // Função para fechar o modal
      function closeModal() {
        const modal = document.getElementById("modal");
        modal.classList.add("hidden");
      }

      document
        .getElementById("logoutBtn")
        .addEventListener("click", async () => {
          try {
            await fetch("/auth/logout", { method: "POST" });
            window.location.href = "/login";
          } catch (error) {
            console.error("Error logging out:", error);
          }
        });

      loadClients();
    </script>
  </body>
</html>
