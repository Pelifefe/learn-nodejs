<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <style>
      .dropdown-content {
        display: none;
        position: absolute;
        right: 0;
        min-width: 160px;
        z-index: 50;
      }

      .dropdown:hover .dropdown-content {
        display: block;
      }
      .modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        padding: 20px;
        width: 600px;
        max-width: 90%;
      }

      .modal-content {
        display: flex;
        flex-direction: column;
      }

      .modal-body {
        display: flex;
        justify-content: space-between;
        gap: 20px;
      }

      .modal-section {
        flex: 1;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 8px;
        background-color: #f9f9f9;
      }

      .modal h2 {
        margin-bottom: 20px;
        text-align: center;
      }

      .modal h3 {
        margin-bottom: 10px;
        color: #333;
      }

      .modal-close {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #d9534f;
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        font-size: 16px;
        cursor: pointer;
      }

      .modal-close:hover {
        background: #c9302c;
      }
    </style>
  </head>
  <body class="bg-gray-100">
    <nav class="bg-white shadow-md">
      <div class="max-w-7xl mx-auto px-4">
        <div class="flex justify-between h-16">
          <div class="flex items-center">
            <span class="text-xl font-bold text-blue-600">Dashboard</span>
          </div>

          <div class="flex items-center">
            <div class="dropdown relative">
              <button
                class="flex items-center space-x-2 text-gray-700 hover:text-gray-900 px-4 py-2 rounded-md"
              >
                <span id="userEmail"></span>
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-5 w-5"
                  viewBox="0 0 20 20"
                  fill="currentColor"
                >
                  <path
                    fill-rule="evenodd"
                    d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"
                    clip-rule="evenodd"
                  />
                </svg>
              </button>

              <div class="dropdown-content bg-white rounded-md shadow-xl mt-2">
                <a
                  href="/profile"
                  class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                >
                  Editar Perfil
                </a>
                <button
                  id="logoutBtn"
                  class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                >
                  Sair
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </nav>
    <div class="container mx-auto px-4 py-8">
      <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex justify-between items-center mb-6">
          <div class="mb-4">
            <input
              type="text"
              id="searchInput"
              class="w-full px-4 py-2 border rounded-md"
              placeholder="Pesquisar clientes..."
            />
          </div>
          <a
            href="/register-client"
            class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded"
          >
            Add Clientes</a
          >
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full table-auto">
            <thead>
              <tr class="bg-gray-200">
                <th class="px-4 py-2 text-left">Nome</th>
                <th class="px-4 py-2 text-left">Status</th>
                <th class="px-4 py-2 text-left">Email</th>
                <th class="px-4 py-2 text-left">Telefone</th>
                <th class="px-4 py-2 text-left">Detalhes</th>
              </tr>
            </thead>
            <tbody id="clientsList">
              <!-- Produtos serão inseridos aqui via JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div id="modal" class="modal hidden">
      <div class="modal-content">
        <h2 id="modalTitle"></h2>
        <div class="modal-body">
          <!-- Primeiro container: Dados Pessoais -->
          <div class="modal-section" id="personalData">
            <h3>Dados Pessoais</h3>
            <p><strong>Nome:</strong> <span id="clientName"></span></p>
            <p><strong>Idade:</strong> <span id="clientAge"></span></p>
            <p><strong>CPF:</strong> <span id="clientCPF"></span></p>
            <h4>Contatos</h4>
            <p><strong>Email:</strong> <span id="clientEmail"></span></p>
            <p><strong>Telefone:</strong> <span id="clientPhone"></span></p>
          </div>
          <!-- Segundo container: Informações -->
          <div class="modal-section" id="additionalInfo">
            <h3>Informações</h3>
            <p><strong>Status:</strong> <span id="clientStatus"></span></p>
            <p>
              <strong>Fidelidade:</strong> <span id="clientFidelity"></span>
            </p>
            <p><strong>Observações:</strong></p>
            <p id="clientObs"></p>
          </div>
        </div>
        <button class="modal-close" onclick="closeModal()">X</button>
      </div>
    </div>

    <script>
      let clients = [];
      async function loadClients() {
        try {
          const response = await fetch("/clients");
          const clients = await response.json();

          const clientsList = document.getElementById("clientsList");
          clientsList.innerHTML = clients
            .map(
              (client, index) => `
          <tr class="border-b">
              <td class="px-4 py-2">${client.name}</td>
              <td class="px-4 py-2">${client.status}</td>
              <td class="px-4 py-2">${client.email}</td>
              <td class="px-4 py-2">${client.telephone.replace(
                /(\d{2})(\d{5})(\d{4})/,
                "($1) $2-$3"
              )}</td>
              <td class="px-4 py-2">
                <button class="modalBtn" data-index="${index}" title="Visualizar">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500 hover:text-blue-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    </svg>
                </button>
              </td>
          </tr>
          `
            )
            .join("");
          // Adicionar eventos de clique aos botões do modal
          document
            .getElementById("clientsList")
            .addEventListener("click", (event) => {
              const button = event.target.closest(".modalBtn"); // Verifica se o botão foi clicado
              if (button) {
                const index = button.getAttribute("data-index");
                openModal(clients[index]); // Passa o cliente correspondente
              }
            });
        } catch (error) {
          console.error("Erro ao carregar clientes:", error);
        }
      }

      function openModal(client) {
        // Função para calcular a idade com base na data de nascimento
        function calculateAge(birthDate) {
          const birth = new Date(birthDate);
          const today = new Date();
          let age = today.getFullYear() - birth.getFullYear();
          const isBirthdayPassed =
            today.getMonth() > birth.getMonth() ||
            (today.getMonth() === birth.getMonth() &&
              today.getDate() >= birth.getDate());
          if (!isBirthdayPassed) {
            age--;
          }
          return age;
        }

        // Calcular a idade do cliente
        const age = calculateAge(client.birth_date);

        // Preencher os dados nos campos correspondentes
        document.getElementById(
          "modalTitle"
        ).innerText = `Detalhes de ${client.name}`;
        document.getElementById("clientName").innerText = client.name;
        document.getElementById("clientAge").innerText = `${age} anos`;
        document.getElementById("clientCPF").innerText = client.cpf.replace(
          /(\d{3})(\d{3})(\d{3})(\d{2})/,
          "$1.$2.$3-$4"
        );
        document.getElementById("clientEmail").innerText = client.email;
        document.getElementById("clientPhone").innerText =
          client.telephone.replace(/(\d{2})(\d{5})(\d{4})/, "($1) $2-$3");
        document.getElementById("clientStatus").innerText = client.status;
        document.getElementById("clientFidelity").innerText =
          client.fidelity || "Não disponível";
        document.getElementById("clientObs").innerText = client.obs;

        // Exibir modal
        document.getElementById("modal").classList.remove("hidden");
      }

      function closeModal() {
        document.getElementById("modal").classList.add("hidden");
      }

      document
        .getElementById("logoutBtn")
        .addEventListener("click", async () => {
          try {
            await fetch("/auth/logout", { method: "POST" });
            window.location.href = "/login";
          } catch (error) {
            console.error("Error logging out:", error);
          }
        });

      loadClients();
    </script>
  </body>
</html>
