<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Edit Cliente</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
      <div class="max-w-md mx-auto bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-bold mb-6 text-center">Editar Perfil</h2>

        <form id="editClientForm">
          <input type="hidden" id="client_id" name="client_id" />

          <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="name"
              >Nome</label
            >
            <input
              class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
              type="text"
              id="name"
              name="name"
              required
            />
          </div>

          <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="cpf"
              >CPF</label
            >
            <input
              class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 bg-gray-100"
              type="text"
              id="cpf"
              name="cpf"
              readonly
            />
          </div>

          <div class="mb-4">
            <label
              class="block text-gray-700 text-sm font-bold mb-2"
              for="email"
              >Email</label
            >
            <input
              class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
              type="email"
              id="email"
              name="email"
              required
            />
          </div>

          <div class="mb-4">
            <label
              class="block text-gray-700 text-sm font-bold mb-2"
              for="telephone"
              >Telefone</label
            >
            <input
              class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
              type="text"
              id="telephone"
              name="telephone"
              required
              pattern="\(\d{2}\) \d{5}-\d{4}"
              placeholder="(00) 00000-0000"
            />
          </div>

          <div class="mb-4">
            <label
              class="block text-gray-700 text-sm font-bold mb-2"
              for="birth_date"
              >Data de Nascimento</label
            >
            <input
              class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
              type="date"
              id="birth_date"
              name="birth_date"
              required
            />
          </div>

          <div class="mb-6">
            <label
              class="block text-gray-700 text-sm font-bold mb-2"
              for="status"
              >Status</label
            >
            <select
              class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
              id="status"
              name="status"
              required
            >
              <option value="em negociação">em negociação</option>
              <option value="contrato fechado">contrato fechado</option>
              <option value="inadimplente">inadimplente</option>
            </select>
          </div>

          <div class="mb-4">
            <div class="mb-4"></div>
            <label
              class="block text-gray-700 text-sm font-bold mb-2"
              for="fidelity"
              >Nível de fidelidade</label
            >
            <input
              class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
              type="number"
              id="fidelity"
              name="fidelity"
              min="1"
              max="5"
              required
            />
          </div>

          <div class="mb-6">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="obs">
              Observações
            </label>
            <textarea
              class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
              id="obs"
              name="obs"
              rows="4"
              maxlength="3000"
              placeholder="Digite suas observações aqui (opcional)"
            ></textarea>
            <p class="text-sm text-gray-500 mt-1">
              <span id="charCount">0</span>/3000 caracteres
            </p>
          </div>

          <div class="flex items-center justify-between">
            <button
              class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
              type="submit"
            >
              Salvar
            </button>
            <a href="/" class="text-blue-500 hover:text-blue-800">Voltar</a>
          </div>
        </form>

        <div id="message" class="mt-4"></div>
      </div>
    </div>

    <script>
      const clientId = window.location.pathname.split("/").pop();

      const obsTextarea = document.getElementById("obs");
      const charCount = document.getElementById("charCount");

      obsTextarea.addEventListener("input", function () {
        charCount.textContent = this.value.length;
      });

      function formatPhone(phone) {
        if (!phone) return "";
        const cleaned = phone.replace(/\D/g, "");
        return cleaned.replace(/(\d{2})(\d{5})(\d{4})/, "($1) $2-$3");
      }

      function cleanPhone(phone) {
        if (!phone) return "";
        return phone.replace(/\D/g, "");
      }

      const telephoneInput = document.getElementById("telephone");

      telephoneInput.addEventListener("input", (e) => {
        let value = cleanPhone(e.target.value);
        if (value.length <= 11) {
          e.target.value = formatPhone(value);
        }
      });

      async function loadEditClient() {
        try {
          const response = await fetch(`/clients/${clientId}`);
          if (!response.ok) throw new Error("Cliente não encontrado");

          const client = await response.json();
          document.getElementById("client_id").value = client.id;
          document.getElementById("name").value = client.name;
          document.getElementById("cpf").value = client.cpf;
          document.getElementById("email").value = client.email;
          document.getElementById("birth_date").value =
            client.birth_date.split("T")[0];
          document.getElementById("status").value = client.status;
          document.getElementById("fidelity").value = client.fidelity;
          document.getElementById("telephone").value = formatPhone(
            client.telephone
          );
          document.getElementById("obs").value = client.obs || "";
          charCount.textContent = (client.obs || "").length;
        } catch (error) {
          console.error("Error:", error);
          window.location.href = "/dashboard";
        }
      }

      document
        .getElementById("editClientForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const formData = new FormData(e.target);
          const data = {
            name: formData.get("name"),
            birth_date: formData.get("birth_date"),
            email: formData.get("email"),
            status: formData.get("status"),
            fidelity: parseInt(formData.get("fidelity")),
            telephone: cleanPhone(formData.get("telephone")),
            obs: formData.get("obs") || "",
          };
          console.log("Dados sendo enviados:", data);
          try {
            const response = await fetch(`/clients/${clientId}`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(data),
            });

            if (!response.ok) {
              const errorResult = await response.json();
              throw new Error(errorResult.error || "Erro ao atualizar cliente");
            }

            document.getElementById("message").className =
              "mt-4 text-green-500";
            document.getElementById("message").textContent =
              "Cliente atualizado com sucesso!";

            setTimeout(() => {
              window.location.href = "/dashboard";
            }, 2000);
          } catch (error) {
            document.getElementById("message").className = "mt-4 text-red-500";
            document.getElementById("message").textContent = error.message;
          }
        });

      loadEditClient();
    </script>
  </body>
</html>
